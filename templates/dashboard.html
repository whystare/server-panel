<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º</title>
  <link rel="stylesheet" href="static/dashboard.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="theme-toggle">
    <label class="theme-switch">
      <input type="checkbox" id="themeCheckbox" />
      <span class="slider">
        <span class="icon sun">‚òÄÔ∏è</span>
        <span class="icon moon">üåô</span>
      </span>
    </label>
  </div>

  <div class="container">
    <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
    <p><strong>Uptime:</strong> <span id="uptime"></span></p>
    <p><strong>OS:</strong> <span id="os"></span></p>
    <p><strong>Hostname:</strong> <span id="hostname"></span></p>
    <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</strong> <span id="users"></span></p>
    <p><strong>–ü—Ä–æ—Ü–µ—Å—Å—ã:</strong> <span id="processes"></span></p>

    <h2>–°–µ—Ç—å</h2>
<div class="card">
  <p><strong>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</strong> <span id="sent">{{ (info.bytes_sent / 1024 / 1024) | round(2) }} MB</span></p>
  <p><strong>–ü–æ–ª—É—á–µ–Ω–æ:</strong> <span id="recv">{{ (info.bytes_recv / 1024 / 1024) | round(2) }} MB</span></p>
</div>

<h2>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h2>
<table id="connectionsTable">
  <thead>
    <tr>
      <th>PID</th>
      <th>–ü—Ä–æ—Ü–µ—Å—Å</th>
      <th>–õ–æ–∫–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å</th>
      <th>–£–¥–∞–ª—ë–Ω–Ω—ã–π –∞–¥—Ä–µ—Å</th>
      <th>–°—Ç–∞—Ç—É—Å</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>


    <h2>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤</h2>
    <canvas id="cpuChart"></canvas>
    <canvas id="ramChart"></canvas>
    <canvas id="diskChart"></canvas>

    <h3>–¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
    <p>CPU: <span id="cpuStatus" class="status-indicator"></span></p>
    <p>RAM: <span id="ramStatus" class="status-indicator"></span></p>
    <p>Disk (/): <span id="diskStatus" class="status-indicator"></span></p>

    <h3>–¢–æ–ø 5 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–æ CPU</h3>
    <table id="topCpuTable">
      <thead>
        <tr><th>PID</th><th>–ò–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞</th><th>CPU %</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>–¢–æ–ø 5 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–æ –ø–∞–º—è—Ç–∏</h3>
    <table id="topMemTable">
      <thead>
        <tr><th>PID</th><th>–ò–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞</th><th>–ü–∞–º—è—Ç—å %</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    const ramCtx = document.getElementById('ramChart').getContext('2d');
    const diskCtx = document.getElementById('diskChart').getContext('2d');

    const cpuChart = new Chart(cpuCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'CPU %', data: [], borderColor: '#ff6384', backgroundColor: 'rgba(255,99,132,0.2)', fill: true, tension: 0.3 }] },
      options: { responsive: true, scales: { y: { min: 0, max: 100, ticks: { stepSize: 10 }}}}
    });

    const ramChart = new Chart(ramCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'RAM %', data: [], borderColor: '#36a2eb', backgroundColor: 'rgba(54,162,235,0.2)', fill: true, tension: 0.3 }] },
      options: { responsive: true, scales: { y: { min: 0, max: 100, ticks: { stepSize: 10 }}}}
    });

    const diskChart = new Chart(diskCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Disk %', data: [], borderColor: '#ffce56', backgroundColor: 'rgba(255,206,86,0.2)', fill: true, tension: 0.3 }] },
      options: { responsive: true, scales: { y: { min: 0, max: 100, ticks: { stepSize: 10 }}}}
    });

    function updateStatusIndicator(elementId, value) {
      const el = document.getElementById(elementId);
      el.textContent = value.toFixed(1) + '%';
      el.className = 'status-indicator ';
      if (value < 50) el.classList.add('low');
      else if (value < 80) el.classList.add('medium');
      else el.classList.add('high');
    }

    function updateTables(topCpu, topMem) {
      const cpuTableBody = document.querySelector('#topCpuTable tbody');
      const memTableBody = document.querySelector('#topMemTable tbody');
      cpuTableBody.innerHTML = '';
      memTableBody.innerHTML = '';

      topCpu.forEach(proc => {
        const row = `<tr><td>${proc.pid}</td><td>${proc.name}</td><td>${proc.cpu.toFixed(1)}</td></tr>`;
        cpuTableBody.insertAdjacentHTML('beforeend', row);
      });
      topMem.forEach(proc => {
        const row = `<tr><td>${proc.pid}</td><td>${proc.name}</td><td>${proc.memory.toFixed(1)}</td></tr>`;
        memTableBody.insertAdjacentHTML('beforeend', row);
      });
    }

    async function fetchMetrics() {
  try {
    const res = await fetch('/api/metrics'); // –º–µ–Ω—è–π URL –Ω–∞ —Å–≤–æ–π API
    if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    const data = await res.json();

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
    document.getElementById('uptime').textContent = data.uptime;
    document.getElementById('os').textContent = data.os;
    document.getElementById('hostname').textContent = data.hostname;
    document.getElementById('users').textContent = data.users;
    document.getElementById('processes').textContent = data.processes;

    // –í—Ä–µ–º—è –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ (–º–µ—Ç–∫–∞ –Ω–∞ –æ—Å–∏ X)
    const timeLabel = new Date().toLocaleTimeString();

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–æ 20 —Ç–æ—á–µ–∫
    if (cpuChart.data.labels.length > 20) {
      cpuChart.data.labels.shift();
      cpuChart.data.datasets[0].data.shift();
      ramChart.data.labels.shift();
      ramChart.data.datasets[0].data.shift();
      diskChart.data.labels.shift();
      diskChart.data.datasets[0].data.shift();
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –≥—Ä–∞—Ñ–∏–∫–∏
    cpuChart.data.labels.push(timeLabel);
    cpuChart.data.datasets[0].data.push(data.cpu_percent);

    ramChart.data.labels.push(timeLabel);
    ramChart.data.datasets[0].data.push(data.ram_percent);

    diskChart.data.labels.push(timeLabel);
    diskChart.data.datasets[0].data.push(data.disk_percent);

    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
    cpuChart.update();
    ramChart.update();
    diskChart.update();

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞
    updateStatusIndicator('cpuStatus', data.cpu_percent);
    updateStatusIndicator('ramStatus', data.ram_percent);
    updateStatusIndicator('diskStatus', data.disk_percent);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã —Å –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
    updateTables(data.top_cpu, data.top_mem);

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–µ—Ç—Ä–∏–∫:', error);
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É –∏ –ø–æ—Ç–æ–º –ø–æ —Ç–∞–π–º–µ—Ä—É
fetchMetrics();
setInterval(fetchMetrics, 5000);


    // –¢–µ–º–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
    const themeCheckbox = document.getElementById('themeCheckbox');

    function setTheme(dark) {
      if (dark) document.body.classList.add('dark-theme');
      else document.body.classList.remove('dark-theme');
      themeCheckbox.checked = dark;
      localStorage.setItem('darkTheme', dark);
    }

    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('darkTheme');
      if (savedTheme !== null) setTheme(savedTheme === 'true');
      else setTheme(false);
      fetchMetrics();
      setInterval(fetchMetrics, 5000);
    });

    themeCheckbox.addEventListener('change', e => setTheme(e.target.checked));
  </script>
  <script>
  async function updateSystemInfo() {
    try {
      const response = await fetch('/api/status');
      if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');

      const data = await response.json();

      if (data.uptime) document.getElementById('uptime').textContent = data.uptime;
      if (data.os) document.getElementById('os').textContent = data.os;
      if (data.hostname) document.getElementById('hostname').textContent = data.hostname;
      if (data.users) document.getElementById('users').textContent = data.users;
      if (data.processes !== undefined) document.getElementById('processes').textContent = data.processes;

    } catch (error) {
      console.warn('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:', error);
      // –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º
    }
  }

  updateSystemInfo();
  setInterval(updateSystemInfo, 5000);
</script>
<form action="{{ url_for('logout') }}" method="POST">
  <button type="submit" class="styled-button"> –í—ã—Ö–æ–¥</button>
</form>

<script>
function updateNetInfo() {
  fetch('/system_info')
    .then(response => response.json())
    .then(data => {
      const sentMB = (data.info.bytes_sent / 1024 / 1024).toFixed(2);
      const recvMB = (data.info.bytes_recv / 1024 / 1024).toFixed(2);
      document.getElementById('sent').innerText = sentMB + ' MB';
      document.getElementById('recv').innerText = recvMB + ' MB';
    });
}

setInterval(updateNetInfo, 3000);
</script>

<script>
  async function loadConnections() {
    const res = await fetch('/api/connections');
    const data = await res.json();
    const tbody = document.querySelector('#connectionsTable tbody');
    tbody.innerHTML = '';

    data.forEach(conn => {
      const row = `<tr>
        <td>${conn.pid}</td>
        <td>${conn.name}</td>
        <td>${conn.laddr}</td>
        <td>${conn.raddr}</td>
        <td>${conn.status}</td>
      </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  loadConnections();

  // –ò –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
  setInterval(loadConnections, 10000);
</script>


</body>
</html>
